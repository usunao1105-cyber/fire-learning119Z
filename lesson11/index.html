<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RescueNote - 消防職員メンタルログ</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8fafc;
            overscroll-behavior-y: none; /* バウンススクロール防止 */
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* モバイル用調整 */
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- アイコン (Lucide代替) ---
        const Icon = ({ path, className, fill="none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Pen: (props) => <Icon {...props} path={<path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />} />,
            List: (props) => <Icon {...props} path={<><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></>} />,
            Activity: (props) => <Icon {...props} path={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>} />,
            Shield: (props) => <Icon {...props} path={<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>} />,
            Wind: (props) => <Icon {...props} path={<path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/>} />,
            Trash: (props) => <Icon {...props} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>} />,
            Send: (props) => <Icon {...props} path={<><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>} />,
            Alert: (props) => <Icon {...props} path={<><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>} />,
            Check: (props) => <Icon {...props} path={<polyline points="20 6 9 17 4 12"/>} />,
            Info: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>} />,
            Phone: (props) => <Icon {...props} path={<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>} />,
        };

        // --- ロジック ---

        const analyzeContent = (text) => {
            const tags = [];
            const guidances = [];
            let score = 0;

            if (text.match(/遺体|損傷|腐敗|凄惨|血|千切|目撃/)) {
                tags.push('視覚ショック');
                score += 2;
                guidances.push({
                    title: '視覚イメージの遮断',
                    action: 'テレビのチャンネルを変えるように、意図的に別の風景を思い浮かべてください。',
                });
            }
            if (text.match(/子供|子ども|幼児|児童|家族|親|泣き声/)) {
                tags.push('共感性ストレス');
                score += 3;
                guidances.push({
                    title: '自分と現場の分離',
                    action: '「これは仕事である」と声に出して区切りをつけ、帰宅後は家族との時間を大切に。',
                });
            }
            if (text.match(/助けられなかった|間に合わなかった|もっと|自分のせい|ミス|失敗/)) {
                tags.push('自責・無力感');
                score += 3;
                guidances.push({
                    title: 'サバイバーズ・ギルト',
                    action: '結果を個人の責任にせず、同僚と技術的な振り返り（デフュージング）を行ってください。',
                });
            }
            if (text.match(/眠れない|寝れない|悪夢|食欲|吐き気|震え|動悸|汗/)) {
                tags.push('身体化反応');
                score += 2;
                guidances.push({
                    title: '身体反応のケア',
                    action: '48時間はカフェイン等を控え、ぬるめのお風呂に浸かりましょう。',
                });
            }
            if (text.match(/何も感じない|現実感がない|ぼーっとする|涙が出ない/)) {
                tags.push('解離・回避');
                score += 2;
                guidances.push({
                    title: '感情の防衛反応',
                    action: '無理に感情を出さず、淡々とルーチンをこなしてください。正常な反応です。',
                });
            }

            let level = 'low';
            if (score >= 4) level = 'high';
            else if (score >= 2) level = 'medium';

            return { tags, level, guidances };
        };

        // --- コンポーネント ---

        const Breathing = () => {
            const [phase, setPhase] = useState('inhale'); // inhale, hold, exhale, hold2
            const [count, setCount] = useState(4);
            const [isActive, setIsActive] = useState(false);

            useEffect(() => {
                let timer;
                if (isActive) {
                    timer = setInterval(() => {
                        setCount((c) => {
                            if (c === 1) {
                                setPhase((p) => {
                                    if (p === 'inhale') return 'hold';
                                    if (p === 'hold') return 'exhale';
                                    if (p === 'exhale') return 'hold2';
                                    return 'inhale';
                                });
                                return 4;
                            }
                            return c - 1;
                        });
                    }, 1000);
                } else {
                    setPhase('inhale');
                    setCount(4);
                }
                return () => clearInterval(timer);
            }, [isActive]);

            const getLabel = () => {
                switch(phase) {
                    case 'inhale': return '鼻から吸う';
                    case 'hold': return '止める';
                    case 'exhale': return '口から吐く';
                    case 'hold2': return '止める';
                }
            };

            const getColor = () => {
                switch(phase) {
                    case 'inhale': return 'bg-blue-500';
                    case 'hold': return 'bg-blue-600';
                    case 'exhale': return 'bg-blue-400';
                    case 'hold2': return 'bg-blue-600';
                }
            };

            return (
                <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 text-center">
                    <h3 className="font-bold text-slate-700 mb-4 flex items-center justify-center gap-2">
                        <Icons.Wind className="w-5 h-5 text-blue-500" />
                        タクティカル・ブリージング
                    </h3>
                    
                    <div className="relative h-40 flex items-center justify-center mb-4">
                        <div className={`
                            w-32 h-32 rounded-full flex items-center justify-center text-white text-3xl font-bold transition-all duration-1000
                            ${getColor()}
                            ${isActive && phase === 'inhale' ? 'scale-110' : ''}
                            ${isActive && phase === 'exhale' ? 'scale-90' : ''}
                        `}>
                            {isActive ? count : "開始"}
                        </div>
                    </div>
                    
                    <p className="text-xl font-bold text-slate-800 mb-6 h-8">
                        {isActive ? getLabel() : "4秒吸う-止める-吐く-止める"}
                    </p>

                    <button 
                        onClick={() => setIsActive(!isActive)}
                        className={`w-full py-3 rounded-xl font-bold text-white transition-colors ${isActive ? 'bg-slate-400' : 'bg-blue-600 hover:bg-blue-700'}`}
                    >
                        {isActive ? '停止' : 'スタート'}
                    </button>
                </div>
            );
        };

        const NoteItem = ({ note, onDelete }) => {
            const { guidances } = analyzeContent(note.content);
            const [isOpen, setIsOpen] = useState(false);

            return (
                <div className="bg-white rounded-xl p-4 shadow-sm border border-slate-100 animate-fade-in">
                    <div className="flex justify-between items-start mb-2">
                        <span className="text-xs text-slate-400">{note.timestamp}</span>
                        <div className="flex gap-2">
                            {note.level === 'high' && <Icons.Alert className="w-4 h-4 text-red-500" />}
                            <button onClick={() => onDelete(note.id)} className="text-slate-300 hover:text-red-400">
                                <Icons.Trash className="w-4 h-4" />
                            </button>
                        </div>
                    </div>
                    
                    <div className="mb-3">
                        <p className="text-slate-800 whitespace-pre-wrap text-sm leading-relaxed line-clamp-3">
                            {isOpen ? note.content : note.content}
                        </p>
                         {/* 長文の場合の開閉ロジックは省略し、今回はシンプルに全表示かスクロール想定 */}
                    </div>

                    <div className="flex flex-wrap gap-1 mb-3">
                        {note.tags.map(tag => (
                            <span key={tag} className="px-2 py-0.5 bg-slate-100 text-slate-500 text-xs rounded-full">
                                #{tag}
                            </span>
                        ))}
                    </div>

                    {guidances.length > 0 && (
                        <div className="mt-3 pt-3 border-t border-slate-100">
                            <div className="flex items-center gap-2 text-indigo-600 text-xs font-bold mb-2">
                                <Icons.Shield className="w-3 h-3" />
                                ガイド
                            </div>
                            {guidances.map((g, i) => (
                                <div key={i} className="bg-indigo-50 p-2 rounded-lg text-xs text-indigo-900 mb-1 last:mb-0">
                                    <span className="font-bold block mb-0.5">{g.title}</span>
                                    {g.action}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- メインアプリ ---

        const App = () => {
            const [activeTab, setActiveTab] = useState('write'); // write, history, check, tool
            const [text, setText] = useState('');
            const [notes, setNotes] = useState([]);
            
            // 診断チェック用
            const [checks, setChecks] = useState({});
            const [checkResult, setCheckResult] = useState(null);

            const saveNote = () => {
                if (!text.trim()) return;
                const analysis = analyzeContent(text);
                const newNote = {
                    id: Date.now().toString(),
                    content: text,
                    timestamp: new Date().toLocaleString('ja-JP', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
                    tags: analysis.tags,
                    level: analysis.level
                };
                setNotes([newNote, ...notes]);
                setText('');
                setActiveTab('history'); // 保存したら履歴へ移動
            };

            const deleteNote = (id) => {
                if(confirm('削除しますか？')) {
                    setNotes(notes.filter(n => n.id !== id));
                }
            };

            const runCheck = () => {
                const count = Object.values(checks).filter(Boolean).length;
                let msg = "";
                let type = "safe";
                
                if (count >= 3) {
                    msg = "警戒: 専門家やピアサポーターへの相談を強く推奨します。一人で抱え込まないでください。";
                    type = "danger";
                } else if (count >= 1) {
                    msg = "注意: ストレス反応が出ています。休息を取り、誰かに話を聞いてもらいましょう。";
                    type = "warning";
                } else {
                    msg = "正常範囲: 今のところ安定しています。継続的なモニタリングを。";
                    type = "success";
                }
                setCheckResult({ msg, type });
            };

            // 画面コンポーネント
            const renderContent = () => {
                switch(activeTab) {
                    case 'write':
                        return (
                            <div className="h-full flex flex-col p-4 animate-fade-in">
                                <div className="bg-white flex-1 rounded-2xl shadow-sm border border-slate-200 p-4 flex flex-col mb-4">
                                    <textarea
                                        className="flex-1 w-full resize-none outline-none text-base leading-relaxed placeholder-slate-300"
                                        placeholder="今の気持ち、現場での出来事をそのまま書き出してください。&#13;&#10;誰にも見られません。"
                                        value={text}
                                        onChange={(e) => setText(e.target.value)}
                                    ></textarea>
                                </div>
                                <button
                                    onClick={saveNote}
                                    disabled={!text.trim()}
                                    className="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:shadow-none transition-all active:scale-95"
                                >
                                    <Icons.Send className="w-5 h-5" />
                                    記録して分析
                                </button>
                                <p className="text-center text-xs text-slate-400 mt-4">
                                    ※記録はブラウザ内にのみ保存され、閉じると消えます。
                                </p>
                            </div>
                        );
                    
                    case 'history':
                        return (
                            <div className="p-4 space-y-4 pb-24 animate-fade-in">
                                {notes.length === 0 ? (
                                    <div className="text-center py-20 text-slate-400">
                                        <Icons.List className="w-12 h-12 mx-auto mb-2 opacity-20" />
                                        <p className="text-sm">まだ記録がありません</p>
                                        <button onClick={() => setActiveTab('write')} className="mt-4 text-indigo-600 font-bold text-sm">記録を作成する</button>
                                    </div>
                                ) : (
                                    notes.map(note => (
                                        <NoteItem key={note.id} note={note} onDelete={deleteNote} />
                                    ))
                                )}
                            </div>
                        );

                    case 'check':
                        return (
                            <div className="p-4 pb-24 animate-fade-in">
                                <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                                    <h2 className="font-bold text-lg mb-4 text-slate-800">1分間セルフチェック</h2>
                                    <p className="text-xs text-slate-500 mb-6">直近1ヶ月の状態について、当てはまるものを選んでください。</p>
                                    
                                    <div className="space-y-3 mb-8">
                                        {[
                                            { id: 'sleep', label: '不眠（寝つきが悪い、途中覚醒）' },
                                            { id: 'flashback', label: '現場の光景が突然よみがえる' },
                                            { id: 'irritation', label: '些細なことでイライラする' },
                                            { id: 'avoidance', label: '現場に関することを避けている' },
                                            { id: 'numbness', label: '感情が麻痺している感覚がある' },
                                            { id: 'guilt', label: '「自分のせいだ」と責めてしまう' },
                                        ].map(item => (
                                            <label key={item.id} className="flex items-center p-3 rounded-lg bg-slate-50 active:bg-slate-100 transition-colors">
                                                <input 
                                                    type="checkbox" 
                                                    className="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 mr-3"
                                                    checked={!!checks[item.id]}
                                                    onChange={() => setChecks(prev => ({...prev, [item.id]: !prev[item.id]}))}
                                                />
                                                <span className="text-sm font-medium text-slate-700">{item.label}</span>
                                            </label>
                                        ))}
                                    </div>

                                    <button 
                                        onClick={runCheck}
                                        className="w-full bg-slate-800 text-white font-bold py-3 rounded-xl mb-4"
                                    >
                                        診断する
                                    </button>

                                    {checkResult && (
                                        <div className={`p-4 rounded-xl text-sm font-bold ${
                                            checkResult.type === 'danger' ? 'bg-red-50 text-red-700 border border-red-200' :
                                            checkResult.type === 'warning' ? 'bg-orange-50 text-orange-700 border border-orange-200' :
                                            'bg-green-50 text-green-700 border border-green-200'
                                        }`}>
                                            {checkResult.msg}
                                        </div>
                                    )}
                                </div>
                            </div>
                        );
                    
                    case 'tool':
                        return (
                            <div className="p-4 pb-24 space-y-4 animate-fade-in">
                                <Breathing />
                                
                                <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                                    <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                                        <Icons.Phone className="w-5 h-5 text-pink-500" />
                                        緊急サポート
                                    </h3>
                                    <div className="space-y-3 text-sm text-slate-600">
                                        <div className="p-3 bg-slate-50 rounded-lg">
                                            <span className="block font-bold text-slate-800 mb-1">所属の指定産業医</span>
                                            <span className="text-xs">まずは所属本部の総務課・担当課へ</span>
                                        </div>
                                        <div className="p-3 bg-slate-50 rounded-lg">
                                            <span className="block font-bold text-slate-800 mb-1">共済組合メンタルヘルス相談</span>
                                            <span className="text-xs">健康保険証に記載の連絡先を確認</span>
                                        </div>
                                        <div className="p-3 bg-slate-50 rounded-lg">
                                            <span className="block font-bold text-slate-800 mb-1">こころの耳（厚生労働省）</span>
                                            <a href="https://kokoro.mhlw.go.jp/" target="_blank" className="text-blue-500 underline text-xs">公式サイトへ</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                }
            };

            return (
                <div className="flex flex-col h-screen bg-slate-50 max-w-md mx-auto shadow-2xl overflow-hidden relative">
                    {/* Header */}
                    <header className="bg-white px-4 py-3 flex items-center justify-between border-b border-slate-100 z-10 shrink-0">
                        <h1 className="font-bold text-slate-800 flex items-center gap-2 text-lg">
                            <Icons.Shield className="w-5 h-5 text-red-500" />
                            RescueNote
                        </h1>
                        <span className="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">
                            {activeTab === 'write' && '記録'}
                            {activeTab === 'history' && '履歴'}
                            {activeTab === 'check' && '診断'}
                            {activeTab === 'tool' && 'ツール'}
                        </span>
                    </header>

                    {/* Main Content Area */}
                    <main className="flex-1 overflow-y-auto relative bg-slate-50">
                        {renderContent()}
                    </main>

                    {/* Bottom Navigation */}
                    <nav className="bg-white border-t border-slate-200 px-2 py-2 safe-area-bottom shrink-0 z-20">
                        <div className="flex justify-around items-center">
                            {[
                                { id: 'write', icon: Icons.Pen, label: '記録' },
                                { id: 'history', icon: Icons.List, label: '履歴' },
                                { id: 'check', icon: Icons.Activity, label: '診断' },
                                { id: 'tool', icon: Icons.Wind, label: 'ケア' },
                            ].map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`flex flex-col items-center justify-center w-16 h-14 rounded-xl transition-all ${
                                        activeTab === tab.id 
                                        ? 'text-indigo-600 bg-indigo-50' 
                                        : 'text-slate-400 hover:bg-slate-50'
                                    }`}
                                >
                                    <tab.icon className={`w-6 h-6 mb-1 ${activeTab === tab.id ? 'stroke-[2.5px]' : 'stroke-2'}`} />
                                    <span className="text-[10px] font-bold">{tab.label}</span>
                                </button>
                            ))}
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
